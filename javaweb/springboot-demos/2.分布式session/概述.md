Session çš„ä¸€è‡´æ€§ï¼Œç®€å•æ¥ç†è§£ï¼Œå°±æ˜¯ç›¸åŒ sessionid åœ¨å¤šä¸ª Web å®¹å™¨ä¸‹ï¼ŒSession çš„æ•°æ®è¦ä¸€è‡´ã€‚

æˆ‘ä»¬å…ˆä»¥ç”¨æˆ·ä½¿ç”¨æµè§ˆå™¨ï¼ŒWeb æœåŠ¡å™¨ä¸º**å•å°** TomcatA ä¸¾ä¾‹å­ã€‚

- æµè§ˆå™¨åœ¨ç¬¬ä¸€æ¬¡è®¿é—® Web æœåŠ¡å™¨ TomcatA æ—¶ï¼ŒTomcatA ä¼šå‘ç°è¯·æ±‚çš„ Cookie ä¸­**ä¸**å­˜åœ¨ sessionid ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ª sessionid ä¸º X çš„ Session ï¼ŒåŒæ—¶å°†è¯¥ sessionid å†™å›ç»™æµè§ˆå™¨çš„ Cookie ä¸­ã€‚
- æµè§ˆå™¨åœ¨ä¸‹ä¸€æ¬¡è®¿é—® Web æœåŠ¡å™¨ TomcatA æ—¶ï¼ŒTomcatA ä¼šå‘ç°è¯·æ±‚çš„ Cookie ä¸­**å·²**å­˜åœ¨ sessionid ä¸º X ï¼Œåˆ™ç›´æ¥è·å¾— X å¯¹åº”çš„ Session ã€‚

æˆ‘ä»¬å†ä»¥ç”¨æˆ·ä½¿ç”¨æµè§ˆå™¨ï¼ŒWeb æœåŠ¡å™¨ä¸º**ä¸¤å°** TomcatAã€TomcatB ä¸¾ä¾‹å­ã€‚

- æ¥ä¸Šè¿°ä¾‹å­ï¼Œæµè§ˆå™¨å·²ç»è®¿é—® TomcatA ï¼Œè·å¾— sessionid ä¸º X ã€‚åŒæ—¶ï¼Œåœ¨å¤šå° Tomcat çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨ Nginx åšè´Ÿè½½å‡è¡¡ã€‚
- æµè§ˆå™¨åˆå‘èµ·ä¸€æ¬¡è¯·æ±‚è®¿é—® Web æœåŠ¡å™¨ï¼ŒNginx è´Ÿè½½å‡è¡¡è½¬å‘è¯·æ±‚åˆ° TomcatB ä¸Šã€‚TomcatB ä¼šå‘ç°è¯·æ±‚çš„ Cookie ä¸­**å·²**å­˜åœ¨ sessionid ä¸º X ï¼Œåˆ™ç›´æ¥è·å¾— X å¯¹åº”çš„ Session ã€‚ç»“æœå‘¢ï¼Œæ‰¾ä¸åˆ° X å¯¹åº”çš„ Session ï¼Œåªå¥½åˆ›å»ºä¸€ä¸ª sessionid ä¸º X çš„ Session ã€‚
- æ­¤æ—¶ï¼Œè™½ç„¶è¯´æµè§ˆå™¨çš„ sessionid æ˜¯ X ï¼Œä½†æ˜¯å¯¹åº”åˆ°ä¸¤ä¸ª Tomcat ä¸­ä¸¤ä¸ª Session ã€‚é‚£ä¹ˆï¼Œå¦‚æœåœ¨ TomcatA ä¸Šåšçš„ Session ä¿®æ”¹ï¼ŒTomcatB çš„ Session è¿˜æ˜¯åŸæ ·ï¼Œè¿™æ ·å°±ä¼šå‡ºç° **Session ä¸ä¸€è‡´**çš„é—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆï¼š

**Session å¤–éƒ¨åŒ–å­˜å‚¨**ã€‚

ä¸åŒäºä¸Šè¿°çš„ä¸¤ç§æ–¹æ¡ˆï¼ŒSession å¤–éƒ¨åŒ–å­˜å‚¨ï¼Œè€ƒè™‘ä¸å†é‡‡ç”¨ Web å®¹å™¨çš„å†…å­˜ä¸­å­˜å‚¨ Session ï¼Œè€Œæ˜¯å°† Session å­˜å‚¨å¤–éƒ¨åŒ–ï¼ŒæŒä¹…åŒ–åˆ° MySQLã€Redisã€MongoDB ç­‰ç­‰æ•°æ®åº“ä¸­ã€‚è¿™æ ·ï¼ŒTomcat å°±å¯ä»¥æ— çŠ¶æ€åŒ–ï¼Œä¸“æ³¨æä¾› Web æœåŠ¡æˆ–è€… API æ¥å£ï¼Œæœªæ¥æ‹“å±•æ‰©å®¹ä¹Ÿå˜å¾—æ›´åŠ å®¹æ˜“ã€‚

è€Œå®ç° Session å¤–éƒ¨åŒ–å­˜å‚¨ä¹Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š

â‘  åŸºäº Tomcatã€Jetty ç­‰ Web å®¹å™¨**è‡ªå¸¦çš„æ‹“å±•**ï¼Œä½¿ç”¨è¯»å–å¤–éƒ¨å­˜å‚¨å™¨çš„ Session ç®¡ç†å™¨ã€‚ä¾‹å¦‚è¯´ï¼š

- [ã€ŠRedisson Tomcatä¼šè¯ç®¡ç†å™¨ï¼ˆTomcat Session Managerï¼‰ã€‹](https://github.com/redisson/redisson/wiki/14.-ç¬¬ä¸‰æ–¹æ¡†æ¶æ•´åˆ#146-spring-sessionä¼šè¯ç®¡ç†å™¨) ï¼Œå®ç°å°† Tomcat ä½¿ç”¨ Redis å­˜å‚¨ Session ã€‚
- [ã€ŠJetty é›†ç¾¤é…ç½® Session å­˜å‚¨åˆ° MySQLã€MongoDBã€‹](https://blog.csdn.net/xiao__gui/article/details/43271509) ï¼Œå®ç° Jetty ä½¿ç”¨ MySQLã€MongoDB å­˜å‚¨ Session ã€‚

â‘¡ åŸºäºåº”ç”¨å±‚å°è£… [HttpServletRequest](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/http/HttpServletRequest.java) è¯·æ±‚å¯¹è±¡ï¼ŒåŒ…è£…æˆè‡ªå·±çš„ RequestWrapper å¯¹è±¡ï¼Œä»è€Œè®©å®ç°è°ƒç”¨ [`HttpServletRequest#getSession()`](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/http/HttpServletRequest.java#L542-L581) æ–¹æ³•æ—¶ï¼Œè·å¾—è¯»å†™å¤–éƒ¨å­˜å‚¨å™¨çš„ SessionWrapper å¯¹è±¡ã€‚ä¾‹å¦‚è¯´ï¼Œç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°çš„æœ¬æ–‡çš„ä¸»è§’ [Spring Session](https://spring.io/projects/spring-session) ã€‚

- Spring Session æä¾›äº† [SessionRepositoryFilter](https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java) è¿‡æ»¤å™¨ï¼Œå®ƒä¼šè¿‡æ»¤è¯·æ±‚æ—¶ï¼Œå°†è¯·æ±‚ HttpServletRequest å¯¹è±¡åŒ…è£…æˆ [SessionRepositoryRequestWrapper](https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L192-L418) å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // SessionRepositoryFilter.java
  
  protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
      // sessionRepository æ˜¯è®¿é—®å¤–éƒ¨æ•°æ®æºçš„æ“ä½œç±»ï¼Œä¾‹å¦‚è¯´è®¿é—® Redisã€MySQL ç­‰ç­‰
      request.setAttribute(SESSION_REPOSITORY_ATTR, this.sessionRepository);
      
  
      // å°†è¯·æ±‚å’Œå“åº”è¿›è¡ŒåŒ…è£…æˆ SessionRepositoryRequestWrapper å’Œ SessionRepositoryResponseWrapper å¯¹è±¡
      SessionRepositoryFilter<S>.SessionRepositoryRequestWrapper wrappedRequest = new SessionRepositoryFilter.SessionRepositoryRequestWrapper(request, response, this.servletContext);
      SessionRepositoryFilter.SessionRepositoryResponseWrapper wrappedResponse = new SessionRepositoryFilter.SessionRepositoryResponseWrapper(wrappedRequest, response);
  
      // ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
      try {
          filterChain.doFilter(wrappedRequest, wrappedResponse);
      } finally {
          // è¯·æ±‚ç»“æŸï¼Œæäº¤ Session åˆ°å¤–éƒ¨æ•°æ®æº
          wrappedRequest.commitSession();
      }
  
  }
  ```

  

- è°ƒç”¨ [`SessionRepositoryRequestWrapper#getSession()`](https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L325-L328) æ–¹æ³•æ—¶ï¼Œè¿”å›çš„æ˜¯è‡ªå·±å°è£…çš„ [HttpSessionWrapper](https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L375-L390) å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // SessionRepositoryFilter#SessionRepositoryRequestWrapper.java
  
  	@Override
  	public HttpSessionWrapper getSession() {
  		return getSession(true);
  	}
  ```

  

- åç»­ï¼Œæˆ‘ä»¬è°ƒç”¨ HttpSessionWrapper çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¯´ `HttpSessionWrapper#setAttribute(String name, Object value)` æ–¹æ³•ï¼Œè®¿é—®çš„å°±æ˜¯å¤–éƒ¨æ•°æ®æºï¼Œè€Œä¸æ˜¯å†…å­˜ä¸­ã€‚

å½“ç„¶ â‘  å’Œ â‘¡ ä¸¤ç§æ–¹æ¡ˆæ€è·¯æ˜¯ç±»ä¼¼ä¸”ä¸€è‡´çš„ï¼Œåªæ˜¯è¯´æ‹“å±•çš„æä¾›è€…å’Œä½ç½®ä¸åŒã€‚ğŸ˜ˆ ç›¸æ¯”æ¥è¯´ï¼Œâ‘¡ ä¼šæ¯” â‘  æ›´åŠ é€šç”¨ä¸€äº›ã€‚