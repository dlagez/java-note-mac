安装见mac安装系列！

- 命令行运行：elasticsearch
- 浏览器访问：http://localhost:9200/
- 命令行运行：kibana
- 浏览器访问：http://localhost:5601/

es就是一个数据库（可以建立索引（库），文档（库中的数据））。

es是**面向文档**的。

| Relational DB | Elasticsearch       |
| ------------- | ------------------- |
| 数据库        | 索引                |
| 表            | types（逐渐被弃用） |
| 行            | documents           |
| 字段          | fields              |

es集群中可以包含多个索引，每个索引中可以包含多个类型（表），每个类型下又可以包含多个文档，每个文档有可以包含多个字段

### 物理设计

es在后台吧每个索引划分成多个分片，每个分片可以在集群中的不同服务器间迁移

一个人就是一个集群。



### 倒排索引：

它适用于快速的全文搜索，一个倒排索引由文档不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。

比如我现在有两个文档，把他们的出现的词都排列出来，然后分别标记两个文档中有无该词条。我现在要搜索两个词，文档一中都有匹配，文档二中之匹配了一个。所以文档一比文档二又更好的相关性。

ref：https://www.elastic.co/guide/cn/elasticsearch/guide/current/inverted-index.html

### IK分词器

即把一段中文划分成一个个关键字。

提供了两个分词算法：

- ik_smart：最少切分
- ik_max_word：最细粒度划分

使用：

```json
// 请求
GET _analyze
{
  "analyzer": "ik_smart",
  "text": "中国共产党"
}
// 返回：
{
  "tokens" : [
    {
      "token" : "中国共产党",
      "start_offset" : 0,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 0
    }
  ]
}
```

```json
// 请求
GET _analyze
{
  "analyzer": "ik_max_word",
  "text": "中国共产党"
}

// 返回
{
  "tokens" : [
    {
      "token" : "中国共产党",
      "start_offset" : 0,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 0
    },
    {
      "token" : "中国",
      "start_offset" : 0,
      "end_offset" : 2,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "国共",
      "start_offset" : 1,
      "end_offset" : 3,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "共产党",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 3
    },
    {
      "token" : "共产",
      "start_offset" : 2,
      "end_offset" : 4,
      "type" : "CN_WORD",
      "position" : 4
    },
    {
      "token" : "党",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 5
    }
  ]
}

```



### rest风格

基本rest命令

| Method | url地址                                         | 描述                   |
| ------ | ----------------------------------------------- | ---------------------- |
| PUT    | localhost:9200/索引名称/类型名称/文档id         | 创建文档(指定文档id)   |
| POST   | localhost:9200/索引名称/类型名称                | 创建文档（随机文档id） |
| POST   | localhost:9200/索引名称/类型名称/文档id/_update | 修改文档               |
| DELETE | localhost:9200/索引名称/类型名称/文档id         | 删除文档               |
| GET    | localhost:9200/索引名称/类型名称/文档id         | 通过id查询文档         |
| POST   | localhost:9200/索引名称/类型名称/_search        | 查询所有数据           |

练习

### 创建索引并插入数据：

下面的操作没问题，但是又个问题，就是插入数据我没有指定数据类型。

/test/type/1 其中test是数据库的名字，type是类型名，1是文档的id

我们put的时候可以先创建数据库，比如只使用 PUT /test 相当于建表语句

```json
PUT /test/type/1
{
  "name": "roczhang",
  "age": 18
}

// 结果
{
  "_index" : "test",
  "_type" : "type",
  "_id" : "1",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

### 数据类型：

- 字符串类型

  text、keyword

- 数值类型

  byte、short、int、long、float、double、等等

- 日期类型

  date

- 布尔值类型

  boolean

- 二进制类型

  binary

### 建表语句

其中mappings表示映射，properties表示属性，name、age、birthday表示字段，以及设置字段类型。

```json
PUT /test2
{
  "mappings": {
     "properties": {
       "name": {
         "type": "text"
       },
       "age": {
         "type": "long"
       },
       "birthday": {
         "type": "date"
       }
     }
  }
}

// 返回建表成功
{
  "acknowledged" : true,
  "shards_acknowledged" : true,
  "index" : "test2"
}
```



### get命令

获取数据库信息

```json

// 获取数据库信息
GET test2
// 结果
{
  "test2" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "long"
        },
        "birthday" : {
          "type" : "date"
        },
        "name" : {
          "type" : "text"
        }
      }
    },
    "settings" : {
      "index" : {
        "routing" : {
          "allocation" : {
            "include" : {
              "_tier_preference" : "data_content"
            }
          }
        },
        "number_of_shards" : "1",
        "provided_name" : "test2",
        "creation_date" : "1631867020453",
        "number_of_replicas" : "1",
        "uuid" : "l8B8b6UHRfmgtGbMHFw7lA",
        "version" : {
          "created" : "7140199"
        }
      }
    }
  }
}

```



### 查看默认的信息

_doc 默认类型，比如说： 

PUT /test/type/1 

会创建一个索引（数据库），其中有一个字段会命名成type，后面这个类型会被删除，_

直接使用PUT /test/_doc/1  即可。

比如过我现在创建了一个索引以及一条数据：但是我创建的时候没有指定数据类型。

```json
PUT /test3/_doc/1
{
  "name": "roczhang",
  "age": 12,
  "birth": "1998-07-11"
}

// 返回
{
  "_index" : "test3",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

现在我们查看一下这个索引的数据类型。如果我们创建索引时没有指定类型，es会帮我们自动指定。

```json
GET test3

// 返回
{
  "test3" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "long"
        },
        "birth" : {
          "type" : "date"
        },
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    "settings" : {
      "index" : {
        "routing" : {
          "allocation" : {
            "include" : {
              "_tier_preference" : "data_content"
            }
          }
        },
        "number_of_shards" : "1",
        "provided_name" : "test3",
        "creation_date" : "1631867584070",
        "number_of_replicas" : "1",
        "uuid" : "4jVCfUwqRPqF1jTDoeTdcQ",
        "version" : {
          "created" : "7140199"
        }
      }
    }
  }
}
```

### 查看所有库的信息

```
GET _cat/indices?v
```

### 修改对象

曾经的方法。又个弊端，如果我们只要修改一个字段，但是我们编写语句的时候需要把其他字段也写上气，不然其他字段会消失。

```json
// 前面我们已经插入了下面的数据
PUT /test3/_doc/1
{
  "name": "roczhang",
  "age": 13,
  "birth": "1998-07-11"
}

// 保持id不变，修改下age，再次插入这个数据
PUT /test3/_doc/1
{
  "name": "roczhang",
  "age": 23,
  "birth": "1998-07-11"
}

// 返回：可以看到版本变成了2，result也变成了updated
{
  "_index" : "test3",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 2,
  "result" : "updated",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 1,
  "_primary_term" : 1
}
```

### 修改指定字段

```json
POST /test3/_doc/1/_update
{
  "doc": {
    "name": "法外狂徒张三"
  }
}

// 返回
{
  "_index" : "test3",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 3,
  "result" : "updated",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 2,
  "_primary_term" : 1
}
```

### 删除库：

索引（库）的删除

```
DELETE test
```

### 搜索（查询，是难点）

传入参数，根据名字查询

```
GET pms/_doc/_search
{
  "query": {
    "match": {
      "brandName": "海澜之家"
    }
  },
}
```

在结果中我们可以看见：hits字段

- 包含索引和文档信息
- 查询的结果总数：total
- 查询出来的具体的文档

```json
{
  "took" : 2,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 3,
      "relation" : "eq"
    },
    "max_score" : 1.2321435,
    "hits" : [
      {
        "_index" : "pms",
        "_type" : "_doc",
        "_id" : "30",
        "_score" : 1.2321435,
        "_source" : {
          "_class" : "com.roczhang.mall.nosql.elasticsearch.document.EsProduct",
          "id" : 30,
          "productSn" : "HNTBJ2E042A",
          "brandId" : 50,
          "brandName" : "海澜之家",
          "productCategoryId" : 8,
          "productCategoryName" : "T恤",
          "pic" : "http://macro-oss.oss-cn-shenzhen.aliyuncs.com/mall/images/20180615/5ad83a4fN6ff67ecd.jpg!cc_350x449.jpg",
          "name" : "HLA海澜之家简约动物印花短袖T恤",
          "subTitle" : "2018夏季新品微弹舒适新款短T男生 6月6日-6月20日，满300减30，参与互动赢百元礼券，立即分享赢大奖",
          "Keywords" : "",
          "price" : 98.0,
          "sale" : 0,
          "newStatus" : 1,
          "recommandStatus" : 1,
          "stock" : 100,
          "promotionType" : 0,
          "sort" : 0,
          "attrValueList" : [
            {
              "id" : 202,
              "productAttributeId" : 39,
              "value" : "短袖",
              "type" : 1,
              "name" : "袖长"
            },
            {
              "id" : 201,
              "productAttributeId" : 38,
              "value" : "2018年夏",
              "type" : 1,
              "name" : "上市时间"
            },
            {
              "id" : 200,
              "productAttributeId" : 37,
              "value" : "青年",
              "type" : 1,
              "name" : "适用人群"
            },
            {
              "id" : 199,
              "productAttributeId" : 25,
              "value" : "夏季",
              "type" : 1,
              "name" : "适用季节"
            },
            {
              "id" : 198,
              "productAttributeId" : 24,
              "type" : 1,
              "name" : "商品编号"
            }
          ]
        }
    ]
  }
}
```

